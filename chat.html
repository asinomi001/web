<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="icon" type="images/x-icon" href="images/title.ico" />
  <style>
    body { font-family: "Comic Sans MS", Arial, sans-serif; background: #f0f4ff; text-align: center; }
    h1 { color: #2b7cff; }
    #chatBox { max-width: 600px; margin: 20px auto; background: white; padding: 10px; border-radius: 6px; min-height: 300px; overflow-y: auto; text-align: left; }
    .message { padding: 5px 10px; margin: 5px 0; border-radius: 6px; max-width: 70%; }
    .self { background: #2b7cff; color: white; margin-left: auto; }
    .friend { background: #ddd; margin-right: auto; }
    input { padding: 10px; width: 70%; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 10px 15px; border-radius: 6px; border: none; background: #2b7cff; color: white; cursor: pointer; transition: 0.2s; }
    button:hover { background: #1a5fd1; }
  </style>
</head>
<body>

<h1>Chat</h1>
<button id="backBtn">⬅ Back to Friends</button>

<div id="chatBox"></div>
<input type="text" id="messageInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>

<script>
// Проверка залогиненного пользователя
const currentUser = JSON.parse(localStorage.getItem('logged_user'));
if(!currentUser){ window.location.href = 'index.html'; }

const activeChatId = localStorage.getItem('active_chat');
const users = JSON.parse(localStorage.getItem('users_db')) || [];
const friend = users.find(u => u.id == activeChatId) || {username: "Unknown"};

const chatBox = document.getElementById('chatBox');
const messageInput = document.getElementById('messageInput');

// Загрузка сообщений
let messages = JSON.parse(localStorage.getItem('messages')) || [];
function renderMessages() {
  chatBox.innerHTML = '';
  messages.filter(m => (m.from === currentUser.id && m.to === activeChatId) || (m.from === activeChatId && m.to === currentUser.id))
          .forEach(m => {
    const div = document.createElement('div');
    div.classList.add('message', m.from === currentUser.id ? 'self' : 'friend');
    div.textContent = m.text;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}
renderMessages();

// Отправка сообщения
document.getElementById('sendBtn').addEventListener('click', () => {
  const text = messageInput.value.trim();
  if(!text) return;
  messages.push({from: currentUser.id, to: activeChatId, text: text});
  localStorage.setItem('messages', JSON.stringify(messages));
  messageInput.value = '';
  renderMessages();
});

// Кнопка назад
document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = 'friends.html';
});
</script>

</body>
</html>
